mongo_dir: mongodb                      # String that will be used in the path of the installation directory
                                        # Useful to test multiple versions of MongoDB on same infrastructure (manual 
                                        # runs for analysing build failures)
                                        # Note: mongo_root is the directory where a mongodb.tar.gz was extracted.
journal_dir: /media/ephemeral1/journal  # If specified, create a symlink to have journal at this path
clean_db_dir: true

mongod_config_file:               # This section is literally a mongod config file
    replication:                  # as specified in https://docs.mongodb.org/manual/reference/configuration-options/
        replSetName: myrs0        # We will use this and completely cease using command line options
    storage:                      # A test can specify any option supported by mongod, including undocumented ones
        engine: wiredTiger
    # etc...
rs_conf:                          # The top level settings for rs.conf() / rs.initiate()
    protocolVersion: 1            # See also node specific settings under topology
    settings:
        heartbeatTimeoutSecs: 10

mongos_config_file: ...
configsvr_config_file: ...

# Note on execution order for the on_* hooks in mongodb_setup:
# 1. mongodb_setup: killall mongod/mongos (entire cluster)
# 2. mongodb_setup: delete old files / directories (e.g. from previous task)
# 3. download_files
# 4. upload_files
# 5. exec_remote (OS shell)
# 6. mongodb_setup: start mongod/mongos (entire cluster)
# 7. exec_mongo_shell (javascript in mongo shell)
# 8. post_exec_remote (OS shell)
#
# Note: each step is guaranteed to execute in isolation. e.g. "on_mongos" would iterate over 
# the list of mongos servers sequentially, it must not execute concurrently on all mongos servers.


on_all_hosts:
    download_files:
      - http://url1
      - http://url2
    upload_files: # Anything? Could download/upload data set or a data directory
      - remote-scripts/file1
      - remote-scripts/file2
    exec_remote: |
        # This would execute in OS shell (before MongoDB cluster is running)
    exec_mongo_shell: |
        # JavaScript to be executed in mongo shell (when MongoDB cluster is running)
        # Note: You can also put .js files in upload_files, and use load() to execute them in mongo shell.
    post_exec_remote: |
        # This would execute in OS shell (after MongoDB cluster is running)
on_servers: (see above)            # servers = union( mongod, mongos, configsvr) = all_hosts - workload_client
on_mongod: (see above)
on_mongos: (see above)
on_configsvr: (see above)
on_workload_client: (see above)
on_host: (see system_setup.yml)

# This defines the cluster topology to deploy, and what to deploy on which IP address.
# Note that it is also possible to override mongod/mongos config file entries on a per-node basis.
topology:
    # Note: It is allowed to, even if most tests wouldn't, specify multiple
    # sharded clusters, replica sets and/or standalone mongod's. Hence a list is used.
    # Initial sync test would specify one 2-node replica set, and a separate standalone server.
  - id: mycluster                             # Optional. Needed if someone ever would configure more than 1 cluster.
    cluster_type: sharded_cluster
    configsvr_type: csrs                      # or "sccc", which is currently not supported
    configsvr:
      - public_ip: ${infrastructure_provisioning.out.configsvr.0.public_ip}
        private_ip: ${infrastructure_provisioning.out.configsvr.0.private_ip}
        config_file: ...                                                 # See the last mongod's below for an example of node specific config
      - public_ip: ${infrastructure_provisioning.out.configsvr.1.public_ip}
        private_ip: ${infrastructure_provisioning.out.configsvr.1.private_ip}
      - public_ip: ${infrastructure_provisioning.out.configsvr.2.public_ip}
        private_ip: ${infrastructure_provisioning.out.configsvr.2.private_ip}
    mongos:
      - public_ip: ${infrastructure_provisioning.out.mongos.0.public_ip}
        private_ip: ${infrastructure_provisioning.out.mongos.0.private_ip}
        config_file: ...                                                    # See the last mongod's below for an example of node specific config
      - public_ip: ${infrastructure_provisioning.out.mongos.1.public_ip}
        private_ip: ${infrastructure_provisioning.out.mongos.1.private_ip}
      - public_ip: ${infrastructure_provisioning.out.mongos.2.public_ip}
        private_ip: ${infrastructure_provisioning.out.mongos.2.private_ip}
    shard: 
      - id: myrs0                # If specified, used as shard name when deploying the cluster.
                                 # Note that replset name = config_file.replication.replSetName
        cluster_type: replset
        mongod:
          - public_ip: ${infrastructure_provisioning.out.mongod.0.public_ip}
            private_ip: ${infrastructure_provisioning.out.mongod.0.private_ip}
            id: my_unique_id     # Shards, replica sets and mongod/mongos processes can have a unique id.
          - public_ip: ${infrastructure_provisioning.out.mongod.1.public_ip}
            private_ip: ${infrastructure_provisioning.out.mongod.1.private_ip}
          - public_ip: ${infrastructure_provisioning.out.mongod.2.public_ip}
            private_ip: ${infrastructure_provisioning.out.mongod.2.private_ip}
      - id: myrs1
        cluster_type: replset
        rs_conf :                                     # It is possible to set top level rs.conf() settings on a per shard basis here
            protocolVersion: 0
        mongod:
          - public_ip: ${infrastructure_provisioning.out.mongod.3.public_ip}
            private_ip: ${infrastructure_provisioning.out.mongod.3.private_ip}
            rs_conf_member:                                                    # The member specific part of rs.conf() json object,
                priority: 2                                                    # to go under rs.conf().member[0]
          - public_ip: ${infrastructure_provisioning.out.mongod.4.public_ip}
            private_ip: ${infrastructure_provisioning.out.mongod.4.private_ip}
          - public_ip: ${infrastructure_provisioning.out.mongod.5.public_ip}
            private_ip: ${infrastructure_provisioning.out.mongod.5.private_ip}
      - id: myrs2
        cluster_type: replset
        mongod:
          - mongodb_binary_archive: <another url>     # Testing a cluster where some nodes are of a different version
            config_file: &diff_mongod_config          # And a different config.
              storage:                                # Note: These are merged (or "upserted") into the 
                engine: inMemory                      # global/common mongod_config_file specified above
            public_ip: ${infrastructure_provisioning.out.mongod.6.public_ip}
            private_ip: ${infrastructure_provisioning.out.mongod.6.private_ip}
          - mongodb_binary_archive: <another url>
            config_file: *diff_mongod_config
            public_ip: ${infrastructure_provisioning.out.mongod.7.public_ip}
            private_ip: ${infrastructure_provisioning.out.mongod.7.private_ip}
          - mongodb_binary_archive: <another url>
            config_file: *diff_mongod_config
            public_ip: ${infrastructure_provisioning.out.mongod.7.public_ip}
            private_ip: ${infrastructure_provisioning.out.mongod.7.private_ip}
  - cluster_type: replset
    mongod:
      - id: myid1
        public_ip: ${infrastructure_provisioning.out.mongod.0.public_ip}
        private_ip: ${infrastructure_provisioning.out.mongod.0.private_ip}
      - id: myid2
        public_ip: ${infrastructure_provisioning.out.mongod.1.public_ip}
        private_ip: ${infrastructure_provisioning.out.mongod.1.private_ip}
      - id: myid3
        public_ip: ${infrastructure_provisioning.out.mongod.2.public_ip}
        private_ip: ${infrastructure_provisioning.out.mongod.2.private_ip}
  - cluster_type: standalone
    id: myid1
    public_ip: ${infrastructure_provisioning.out.mongod.0.public_ip}
    private_ip: ${infrastructure_provisioning.out.mongod.0.private_ip}


# Meta data about this mongodb setup
# It is possible to provide meta data that is not used by mongodb_setup itself, but that can be convenient to reference 
# from the other modules. In particular, see the test_control module doing that in run.0.workload_config.mongo
meta:
    # The list of hosts that can be used in a mongodb connection string
    hosts: ${mongodb_setup.topology.0.mongos.0.private_ip}:27017,${mongodb_setup.topology.0.mongos.1.private_ip}:27017,${mongodb_setup.topology.0.mongos.2.private_ip}:27017
    username: myusername
    password: mypassword
    is_sharded: true
    is_replset: false
