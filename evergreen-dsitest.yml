command_type: system

pre:
  - command: shell.track

post:
  - command: shell.cleanup

functions:
  setup_tests:
    - command: git.get_project
      params:
        directory: src
    - command: git.apply_patch
      params:
        directory: src
    - command: shell.exec
      type: test
      params:
        working_dir: src
        script: |
          virtualenv ./venv
          source ./venv/bin/activate
          pip install -r requirements-dev.txt
          echo "building credentials file"
          cat > config.yml << END_OF_CREDS
          {
            evergreen: {
              user: "xgen-evg-user",
              api_key: ${evergreen_token},
              ui_server_host: "https://evergreen.mongodb.com"
            },
            github: {
              token: ${github_token}
            }
          }
          END_OF_CREDS

  check_python_formatting:
    - command: shell.exec
      type: test
      params:
        working_dir: src
        script: |
          source ./venv/bin/activate
          PYTHONPATH=analysis:bin:. python ./testscripts/check_format_python.py

  lint_python_scripts:
    - command: shell.exec
      type: test
      params:
        working_dir: src
        script: |
          source ./venv/bin/activate
          bash testscripts/lint-python.sh

  lint_yml:
    - command: shell.exec
      type: test
      params:
        working_dir: src
        script: |
          source ./venv/bin/activate
          bash testscripts/lint-yml.sh

  nosetests:
    - command: shell.exec
      params:
        working_dir: src
        script: |
          source ./venv/bin/activate
          if [ -f /data/dsitest/override_responses ]
          # If the file is found, save it to the src directory
          # so it does not have to be reproduced for nosetests
          then
              echo "Cached override_responses found; using cached file for nosetests"
              cp /data/dsitest/override_responses ./tests/unittest-files/override_responses
          else
          # If the file is not found, generate it and save to
          # /data/dsitest/override_responses and to the src directory
              echo "Cached override_responses not found"
              echo "generating file and saving it to /data/dsitest/override_responses"
              PYTHONPATH=analysis:bin:. python ./tests/update_override_responses.py
              mkdir -p /data/dsitest
              cp ./tests/unittest-files/override_responses /data/dsitest/override_responses
          fi

    - command: shell.exec
      type: test
      params:
        working_dir: src
        script: |
          source ./venv/bin/activate
          bash testscripts/run-nosetest.sh

    - command: shell.exec
      params:
        working_dir: src
        script: |
          cp ./tests/unittest-files/override_responses /data/dsitest/override_responses

  validate_overrides:
    - command: shell.exec
      type: test
      params:
        working_dir: src
        script: |
          source ./venv/bin/activate
          perf_jira_user="${perf_jira_user}" perf_jira_pw="${perf_jira_pw}" bash testscripts/validate-overrides.sh
#######################################
#               Tasks                 #
#######################################
tasks:
- name: check_python_formatting
  commands:
    - func: setup_tests
    - func: check_python_formatting
- name: lint_python_scripts
  commands:
    - func: setup_tests
    - func: lint_python_scripts
- name: lint_yml
  commands:
    - func: setup_tests
    - func: lint_yml
- name: nosetests
  commands:
    - func: setup_tests
    - func: nosetests
- name: validate_overrides
  commands:
    - func: setup_tests
    - func: validate_overrides


#######################################
#            Buildvariants            #
#######################################

buildvariants:
- name: linux-runner
  display_name: Linux
  run_on:
      - "rhel70-perf-standalone"
  tasks:
    - name: check_python_formatting
    - name: lint_python_scripts
    - name: lint_yml
    - name: nosetests
    - name: validate_overrides
