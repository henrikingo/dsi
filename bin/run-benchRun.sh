#!/bin/bash

set -e

STORAGE_ENGINE=$1
CLUSTER=$3

BINDIR=$(dirname $0)
source $BINDIR/setting.sh

eval `ssh-agent -s`
ssh-add $PEMFILE

# Bridging a historical inconsistency: prior to refactoring, the test name for
# MMAPv1 engine was "benchRun-mmap". However, the parameter ${storageEngine}
# has the value "mmapv1" (which is the name of the engine in mongod config).
if [ $STORAGE_ENGINE == "mmapv1" ]
then
    STORAGE_ENGINE="mmap"
fi

if [ $STORAGE_ENGINE != "wiredTiger" ]
then
    TEST="benchRun-$STORAGE_ENGINE"
else
    TEST="benchRun"
fi

cat ips.sh
rm -rf ./reports
rm -f ../../reports.tgz

source ${BINDIR}/setup-workloads.sh

# PERF-531. Generating config file for mission control.
python $BINDIR/config_test_control.py
echo "Generated mc.json"

#TODO: If a config file is generated by config_test_control.py it should be copied up.
if [ -e workloads.yml ]; then
   scp -oStrictHostKeyChecking=no -i $PEMFILE  workloads.yml $SSHUSER@$mc:./workloads/
fi
if [ -e fio.ini ]; then
   scp -oStrictHostKeyChecking=no -i $PEMFILE  fio.ini $SSHUSER@$mc:./
fi


cat mc.json

MC=${MC:-"${BINDIR}/mc"}
MC_MONITOR_INTERVAL=1 $MC -config mc.json -run $TEST-run -o perf.json

chmod 777 perf.json

# Copy back over timestamp csv file
scp -oStrictHostKeyChecking=no -i $PEMFILE  $SSHUSER@$mc:./workloads/workload_timestamps.csv reports || true

# Copy back over fio output file if it exists
scp -oStrictHostKeyChecking=no -i $PEMFILE  $SSHUSER@$mc:./fio.json reports || true
scp -oStrictHostKeyChecking=no -i $PEMFILE  $SSHUSER@$mc:./fio.json.[0-9] reports || true
scp -oStrictHostKeyChecking=no -i $PEMFILE  $SSHUSER@$mc:./fio.json.p.[0-9] reports || true

rm -f ../perf.json
chmod 766 perf.json
cp ./perf.json ..
pwd
cat ../perf.json
