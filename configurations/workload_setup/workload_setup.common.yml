mongoshell:
  - on_localhost:
      checkout_repos:
        - source: git@github.com:10gen/workloads.git
          target: ${bootstrap.workloads_dir}
  - on_workload_client:
      exec: rm -rf workloads*
  - on_workload_client:
      upload_files:
        - source: ${bootstrap.workloads_dir}
          target: ./workloads
  - on_workload_client:
      exec: |
        sudo pip install argparse python-dateutil pytz

fio:
  - on_workload_client:
      exec: |
        sudo yum -y -q install fio
      upload_repo_files:
        - source: bin/fio-test.sh
          target: fio-test.sh


iperf:
  - on_all_hosts:
      # Install iperf3. It isn't available in yum on AWS instances
      # TODO: This is very verbose. Please change this to yum install from EPEL instead.
      exec: |
        sudo yum groupinstall -y --quiet "Development tools"
        sudo yum install -y --quiet zlib-devel
        sudo killall iperf3
        rm -rf iperf
        git clone --quiet https://github.com/esnet/iperf
        cd iperf/
        git checkout --quiet d06415822a
        ./configure --quiet
        make --quiet
        sudo make install
      upload_repo_files:
        - source: bin/iperf-test.sh
          target: iperf-test.sh

linkbench:
  - on_workload_client:
      exec: |
        ${workload_setup.install_java}

        curl --retry 10 -fsS  \
          https://s3-us-west-2.amazonaws.com/dsi-donot-remove/utils/install_maven.sh | sudo bash
        rm *.rpm || true
  - on_localhost:
      checkout_repos:
        - source: git@github.com:10gen/linkbench.git
          target: ${bootstrap.linkbench_dir}
          branch: a1c7f628cb8631a0c2d1af5a26a9b13d64a50d52
  - on_workload_client:
      exec: rm -rf linkbench*
  - on_workload_client:
      upload_files:
        - source: ${bootstrap.linkbench_dir}
          target: ./linkbench
  - on_workload_client:
      exec: |
        export JAVA_HOME="/usr/java/jdk1.8.0_162/jre"
        source /etc/profile.d/maven.sh && cd /home/ec2-user/linkbench
        mvn --quiet clean package -DskipTests

ycsb:
  - on_workload_client:
      exec: |
        ${workload_setup.install_java}

        curl --retry 10 -fsS \
          https://s3-us-west-2.amazonaws.com/dsi-donot-remove/utils/install_maven.sh | sudo bash
        rm *.rpm || true
  - on_localhost:
      checkout_repos: ${workload_setup.authentication.${bootstrap.authentication}}
  - on_workload_client:
      exec: rm -rf ycsb*
  - on_workload_client:
      upload_files:
        - source: ${bootstrap.ycsb_dir}
          target: ./YCSB
  - on_workload_client:
      exec: |
        export JAVA_HOME="/usr/java/jdk1.8.0_162/jre"
        source /etc/profile.d/maven.sh && cd /home/ec2-user/YCSB/ycsb-mongodb && mvn --quiet clean package

install_java: |
  curl -O --retry 10 -fsS \
    https://s3-us-west-2.amazonaws.com/dsi-donot-remove/java/jdk-8u162-linux-x64.rpm
  sudo rpm -i jdk-8u162-linux-x64.rpm
  sudo /usr/sbin/alternatives --install /usr/bin/java java /usr/java/jdk1.8.0_162/bin/java 20000

# This is temporary, until we put auth into production.
authentication:
  enabled:
    - source: git@github.com:mongodb-labs/YCSB.git
      target: ${bootstrap.ycsb_dir}
      branch: PERF-1293-ssl
  disabled:
    - source: git@github.com:mongodb-labs/YCSB.git
      target: ${bootstrap.ycsb_dir}
      branch: 5742781
