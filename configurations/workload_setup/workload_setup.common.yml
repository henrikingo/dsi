genny:
  - on_localhost:
      checkout_repos:
        - source: git@github.com:mongodb/genny.git
          target: ${bootstrap.genny_dir}
          branch: master
  - on_workload_client:
      upload_files:
        - source: ${bootstrap.genny_dir}
          target: ./data/genny
  # System Setup
  - on_workload_client:
      exec: |
        set -eou pipefail

        mkdir -p data/tmp; pushd data/tmp
        sudo yum update -y > ./yum-update.log
        # https://aws.amazon.com/premiumsupport/knowledge-center/ec2-enable-epel/
        sudo yum install -y https://s3-us-west-2.amazonaws.com/dsi-donot-remove/genny/epel-release-latest-7.noarch.rpm  || true > ./yum-epel-repo.log 2>&1
        sudo yum-config-manager --enable epel > ./yum-epel.log 2>&1
        sudo yum install -y gcc gcc-c++ python3 python3-pip > ./yum-install.log 2>&1
        popd
  # Get Genny's distribution
  - on_workload_client:
      exec: |
        set -eou pipefail

        # Create /data/mci for gennytoolchain and put it on the ephemeral drive.
        mkdir -p ./data/mci
        sudo mkdir -p /data
        sudo ln -s "$PWD/data/mci" /data/mci

        cd ./data/genny
        ./scripts/lamp --linux-distro amazon2 -DGENNY_INSTALL_DIR="$PWD"

  # Make sure the genny executable is reasonable
  - on_workload_client:
      exec: |
        set -eou pipefail

        cd ./data

        ldd genny/bin/genny
        genny/bin/genny --list-actors

  # Build Genny's Python Component
  - on_workload_client:
      exec: |
        cd ./data/genny/src/python
        sudo pip3 install .

mongoshell:
  - on_localhost:
      checkout_repos:
        - source: git@github.com:10gen/workloads.git
          target: ${bootstrap.workloads_dir}
  - on_workload_client:
      exec: rm -rf workloads*
  - on_workload_client:
      upload_files:
        - source: ${bootstrap.workloads_dir}
          target: ./workloads
  - on_workload_client:
      exec: |
        sudo pip install argparse python-dateutil pytz

fio:
  - on_workload_client:
      exec: |
        sudo yum -y -q install fio
      upload_repo_files:
        - source: bin/fio-test.sh
          target: fio-test.sh


iperf:
  - on_all_hosts:
      # Install iperf3. It isn't available in yum on AWS instances
      # TODO: This is very verbose. Please change this to yum install from EPEL instead.
      exec: |
        mkdir -p data/tmp; pushd data/tmp
        sudo yum groupinstall -y --quiet "Development tools"
        sudo yum install -y --quiet zlib-devel
        sudo killall iperf3
        rm -rf iperf
        git clone --quiet https://github.com/esnet/iperf
        cd iperf/
        git checkout --quiet d06415822a
        ./configure --quiet > ./iperf-config.log
        make --quiet > ./iperf-make.log
        sudo make install > ./iperf-install.log
        popd

      upload_repo_files:
        - source: bin/iperf-test.sh
          target: iperf-test.sh

tpcc:
  - on_localhost:
      checkout_repos:
        - source: git@github.com:10gen/py-tpcc.git
          target: ${bootstrap.tpcc_dir}
          branch: 52185e96bf28be6608ea65b61ff1d134b7cb3f13
  - on_workload_client:
      exec: rm -rf tpcc*
  - on_workload_client:
      upload_files:
        - source: ${bootstrap.tpcc_dir}
          target: ./tpcc
  - on_workload_client:
      exec: |
        python -m pip install pymongo==3.7.2 --user

linkbench:
  - on_workload_client:
      exec: |
        mkdir -p data/tmp; pushd data/tmp
        curl --retry 10 -fsS  \
          https://s3-us-west-2.amazonaws.com/dsi-donot-remove/utils/install_maven.sh | sudo bash
        rm *.rpm || true
        popd

# TODO: EVG-3317  modules can only track branches at the moment
# but master ==  f9cca9bcc2c45a409d34584dad49a095d7efccef. If we need to track
# a specific commit then this code will need to be placed back.
#  - on_localhost:
#      checkout_repos:
#        - source: git@github.com:10gen/linkbench.git
#          target: ${bootstrap.linkbench_dir}
#          branch: f9cca9bcc2c45a409d34584dad49a095d7efccef
  - on_workload_client:
      exec: rm -rf linkbench*
  - on_workload_client:
      upload_files:
        - source: ${bootstrap.linkbench_dir}
          target: ./linkbench
  - on_workload_client:
      exec: |
        export JAVA_HOME="/usr/java/jdk1.8.0_162/jre"
        source /etc/profile.d/maven.sh && cd /home/ec2-user/linkbench
        mvn --quiet clean package -DskipTests

ycsb:
  - on_localhost:
      exec: |
        ${workload_setup.install_curator}
  - on_workload_client:
      exec: |
        mkdir -p data/tmp; pushd data/tmp
        curl --retry 10 -fsS \
          https://s3-us-west-2.amazonaws.com/dsi-donot-remove/utils/install_maven.sh | sudo bash
        rm *.rpm || true
        popd
  - on_localhost:
      checkout_repos:
        - source: git@github.com:mongodb-labs/YCSB.git
          target: ${bootstrap.ycsb_dir}
          branch: 9e7888c5009e44a185b135104dd8456eea1deb1e
  - on_workload_client:
      exec: rm -rf ycsb*
  - on_workload_client:
      upload_files:
        - source: ${bootstrap.ycsb_dir}
          target: ./YCSB
  - on_workload_client:
      exec: |
        export JAVA_HOME="/usr/java/jdk1.8.0_162/jre"
        source /etc/profile.d/maven.sh && cd /home/ec2-user/YCSB/ycsb-mongodb && mvn -Dmongo.version=3.8.1 --quiet clean package

install_curator: |
  curl -o curator.tar.gz --retry 10 -LsS "${bootstrap.curator_url}"
  tar xvf curator.tar.gz
  ./curator --version
