task_name: ycsb.longevity
run:
  - id: ycsb_load
    type: ycsb
    "cmd": "cd YCSB/ycsb-mongodb; ${infrastructure_provisioning.numactl_prefix} ./bin/ycsb load mongodb -s -P ../../workloadLongevity -p mongodb.url=${mongodb_setup.meta.mongodb_url} -threads 32"
    config_filename: workloadLongevity
    workload_config: |
      recordcount=50000000
      operationcount=2000000000
      workload=com.yahoo.ycsb.workloads.CoreWorkload
      readallfields=true
      readproportion=0.5
      updateproportion=0.5
      scanproportion=0
      insertproportion=0.0
      requestdistribution=zipfian

  - id: ycsb_50read50update
    type: ycsb
    "cmd": "cd YCSB/ycsb-mongodb; ${infrastructure_provisioning.numactl_prefix} ./bin/ycsb run mongodb -s -P ../../workloadLongevity -p mongodb.url=${mongodb_setup.meta.mongodb_url} -threads 64 -p maxexecutiontime=86400"

  - id: fio
    type: fio
    cmd: ' ${infrastructure_provisioning.numactl_prefix} ./fio-test.sh ${mongodb_setup.meta.hostname}'
    config_filename: fio.ini
    output_files:
      - fio.json
      - fio_results.tgz
    workload_config: ${test_control.common_fio_config}
    skip_validate: true

  - id: iperf
    type: iperf
    cmd: '${infrastructure_provisioning.numactl_prefix} ./iperf-test.sh ${mongodb_setup.meta.hostname}'
    output_files:
      - iperf.json
    skip_validate: true

between_tests:
  - restart_mongodb:
      clean_logs: true
      clean_db_dir: false

pre_task:
  - on_workload_client:
      exec_mongo_shell:
        connection_string: "${mongodb_setup.meta.hostname}:${mongodb_setup.meta.port}"
        # Shard the YCSB cluster if sharding is enabled
        script: |
          if ("${mongodb_setup.meta.is_sharded}" == "True") {
            // Temporary fix for BF-8489.
            // If do not sleep before executing sharding commands when auth is enabled, these
            // commands may fail.
            if ("${bootstrap.authentication}" == "enabled") {
              sleep(2000);
            }
            assert.commandWorked(sh.enableSharding("ycsb"));
            assert.commandWorked(
              sh.shardCollection("ycsb.usertable", {_id: "hashed"}));
            db.printShardingStatus();
          } else {
            print ("Non-sharded cluster");
          }

numactl: ""
