task_name: ycsb-wmajority
run:
  - id: ycsb_load
    type: ycsb
    cmd: >
      cd YCSB/ycsb-mongodb;
      ${infrastructure_provisioning.numactl_prefix} ./bin/ycsb load mongodb -s
      -P workloads/workloadEvergreen
      -threads ${test_control.thread_levels.load.${mongodb_setup.meta.storageEngine}};
      sleep 1;
    config_filename: workloadEvergreen
    workload_config: |
      mongodb.url=mongodb://${mongodb_setup.meta.hosts}/ycsb?w=majority
      recordcount=5000000
      operationcount=20000000
      workload=com.yahoo.ycsb.workloads.CoreWorkload
      readallfields=true
      readproportion=1.0
      updateproportion=0.0
      scanproportion=0
      insertproportion=0.0
      requestdistribution=zipfian
    pre_test:
      - on_workload_client:
          upload_files:
            - source: workloadEvergreen
              target: YCSB/ycsb-mongodb/workloads/workloadEvergreen

  - id: ycsb_95read5update_w_majority
    type: ycsb
    cmd: >
      cd YCSB/ycsb-mongodb;
      ${infrastructure_provisioning.numactl_prefix} ./bin/ycsb run mongodb -s
      -P workloads/workloadEvergreen_95read5update
      -threads ${test_control.thread_levels.level95-5.${mongodb_setup.meta.mongodb_setup}};
      sleep 1;
    config_filename: workloadEvergreen_95read5update
    workload_config: |
      mongodb.url=mongodb://${mongodb_setup.meta.hosts}/ycsb?w=majority
      recordcount=5000000
      operationcount=20000000
      workload=com.yahoo.ycsb.workloads.CoreWorkload
      readallfields=true
      readproportion=0.95
      updateproportion=0.05
      scanproportion=0
      insertproportion=0.0
      requestdistribution=zipfian
    pre_test:
      - on_workload_client:
          upload_files:
            - source: workloadEvergreen_95read5update
              target: YCSB/ycsb-mongodb/workloads/workloadEvergreen_95read5update

  - id: ycsb_95read5update_single_w_majority
    type: ycsb
    cmd: >
      cd YCSB/ycsb-mongodb;
      ${infrastructure_provisioning.numactl_prefix} ./bin/ycsb run mongodb -s
      -P workloads/workloadEvergreen_95read5update
      -threads 1
      -p maxexecutiontime=600;
      sleep 1;

  - id: ycsb_50read50update_w_majority
    type: ycsb
    cmd: >
      cd YCSB/ycsb-mongodb;
      ${infrastructure_provisioning.numactl_prefix} ./bin/ycsb run mongodb -s
      -P workloads/workloadEvergreen_50read50update
      -threads ${test_control.thread_levels.level50-50.${mongodb_setup.meta.mongodb_setup}.${mongodb_setup.meta.storageEngine}}
      -p maxexecutiontime=600;
      sleep 1;
    config_filename: workloadEvergreen_50read50update
    workload_config: |
      mongodb.url=mongodb://${mongodb_setup.meta.hosts}/ycsb?w=majority
      recordcount=5000000
      operationcount=20000000
      workload=com.yahoo.ycsb.workloads.CoreWorkload
      readallfields=true
      readproportion=0.5
      updateproportion=0.5
      scanproportion=0
      insertproportion=0.0
      requestdistribution=zipfian
    pre_test:
      - on_workload_client:
          upload_files:
            - source: workloadEvergreen_50read50update
              target: YCSB/ycsb-mongodb/workloads/workloadEvergreen_50read50update

  - id: ycsb_50read50update_single_w_majority
    type: ycsb
    cmd: >
      cd YCSB/ycsb-mongodb;
      ${infrastructure_provisioning.numactl_prefix} ./bin/ycsb run mongodb -s
      -P workloads/workloadEvergreen_50read50update
      -threads 1
      -p maxexecutiontime=600;
      sleep 1;

  - id: fio
    type: fio
    cmd: '${infrastructure_provisioning.numactl_prefix} ./fio-test.sh ${mongodb_setup.meta.hostname}'
    config_filename: fio.ini
    workload_config: ${test_control.common_fio_config}
    skip_validate: true
    pre_test:
      - on_workload_client:
          upload_files:
            - source: fio.ini
              target: fio.ini
    post_test:
      - on_workload_client:
          retrieve_files:
            - source: fio.json
              target: ../fio.json

  - id: iperf
    type: iperf
    cmd: '${infrastructure_provisioning.numactl_prefix} ./iperf-test.sh ${mongodb_setup.meta.hostname}'
    skip_validate: true
    post_test:
      - on_workload_client:
          retrieve_files:
            - source: iperf.json
              target: ../iperf.json

thread_levels:
  load:
    mmapv1: 256
    wiredTiger: 512
  level50-50:
    shard:
      mmapv1: 512
      wiredTiger: 512
    replica:
      mmapv1: 128
      wiredTiger: 512
  level95-5:
    shard: 128
    replica: 64

between_tests:
  - restart_mongodb:
      clean_logs: true
      clean_db_dir: false
