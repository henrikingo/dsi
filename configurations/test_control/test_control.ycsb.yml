task_name: ycsb
run:
  - id: ycsb_load
    type: ycsb
    cmd: >
      cd YCSB/ycsb-mongodb;
      ${infrastructure_provisioning.numactl_prefix} ./bin/ycsb load mongodb -s
      -P workloads/workloadEvergreen
      -threads ${test_control.thread_levels.load.${mongodb_setup.meta.is_sharded}.${mongodb_setup.meta.storageEngine}};
      sleep 1;
    config_filename: workloadEvergreen
    workload_config: |
      mongodb.url=mongodb://${mongodb_setup.meta.hosts}/ycsb
      recordcount=5000000
      operationcount=20000000
      workload=com.yahoo.ycsb.workloads.CoreWorkload
      readallfields=true
      readproportion=1.0
      updateproportion=0.0
      scanproportion=0
      insertproportion=0.0
      requestdistribution=zipfian
    pre_test:
      - on_workload_client:
          upload_files:
            workloadEvergreen: YCSB/ycsb-mongodb/workloads/workloadEvergreen

  - id: ycsb_100read
    type: ycsb
    cmd: >
      cd YCSB/ycsb-mongodb;
      ${infrastructure_provisioning.numactl_prefix} ./bin/ycsb run mongodb -s
      -P workloads/workloadEvergreen
      -threads 64;
      sleep 1;

  - id: ycsb_95read5update
    type: ycsb
    cmd: >
      cd YCSB/ycsb-mongodb;
      ${infrastructure_provisioning.numactl_prefix} ./bin/ycsb run mongodb -s
      -P workloads/workloadEvergreen_95read5update
      -threads ${test_control.thread_levels.95-5.${mongodb_setup.meta.is_sharded}};
      sleep 1;
    config_filename: workloadEvergreen_95read5update
    workload_config: |
      mongodb.url=mongodb://${mongodb_setup.meta.hosts}/ycsb
      recordcount=5000000
      operationcount=20000000
      workload=com.yahoo.ycsb.workloads.CoreWorkload
      readallfields=true
      readproportion=0.95
      updateproportion=0.05
      scanproportion=0
      insertproportion=0.0
      requestdistribution=zipfian
    pre_test:
      - on_workload_client:
          upload_files:
            workloadEvergreen_95read5update: YCSB/ycsb-mongodb/workloads/workloadEvergreen_95read5update

  - id: ycsb_100update
    type: ycsb
    cmd: >
      cd YCSB/ycsb-mongodb;
      ${infrastructure_provisioning.numactl_prefix} ./bin/ycsb run mongodb -s
      -P workloads/workloadEvergreen_100update
      -threads ${test_control.thread_levels.100-0.${mongodb_setup.meta.is_sharded}.${mongodb_setup.meta.storageEngine}};
      sleep 1;
    config_filename: workloadEvergreen_100update
    workload_config: |
      mongodb.url=mongodb://${mongodb_setup.meta.hosts}/ycsb
      recordcount=5000000
      operationcount=20000000
      workload=com.yahoo.ycsb.workloads.CoreWorkload
      readallfields=true
      readproportion=0
      updateproportion=1.0
      scanproportion=0
      insertproportion=0.0
      requestdistribution=zipfian
    pre_test:
      - on_workload_client:
          upload_files:
            workloadEvergreen_100update: YCSB/ycsb-mongodb/workloads/workloadEvergreen_100update

  - id: ycsb_50read50update
    type: ycsb
    cmd: >
      cd YCSB/ycsb-mongodb;
      ${infrastructure_provisioning.numactl_prefix} ./bin/ycsb run mongodb -s
      -P workloads/workloadEvergreen_50read50update
      -threads ${test_control.thread_levels.50-50.${mongodb_setup.meta.is_sharded}.${mongodb_setup.meta.storageEngine}};
      sleep 1;
    config_filename: workloadEvergreen_50read50update
    workload_config: |
      mongodb.url=mongodb://${mongodb_setup.meta.hosts}/ycsb
      recordcount=5000000
      operationcount=20000000
      workload=com.yahoo.ycsb.workloads.CoreWorkload
      readallfields=true
      readproportion=0.5
      updateproportion=0.5
      scanproportion=0
      insertproportion=0.0
      requestdistribution=zipfian
    pre_test:
      - on_workload_client:
          upload_files:
            workloadEvergreen_50read50update: YCSB/ycsb-mongodb/workloads/workloadEvergreen_50read50update

  - id: fio
    type: shell
    cmd: '${infrastructure_provisioning.numactl_prefix} ./fio-test.sh ${mongodb_setup.meta.hostname}'
    config_filename: fio.ini
    workload_config: ${test_control.common_fio_config}
    skip_validate: true
    pre_test:
      - on_workload_client:
          upload_files:
            fio.ini: fio.ini
    post_test:
      - on_workload_client:
          retrieve_files:
            fio.json: ../fio.json

  - id: iperf
    type: shell
    cmd: '${infrastructure_provisioning.numactl_prefix} ./iperf-test.sh ${mongodb_setup.meta.hostname}'
    skip_validate: true
    post_test:
      - on_workload_client:
          retrieve_files:
            iperf.json: ../iperf.json

thread_levels:
  load:
    "True":  # Sharded
      mmapv1: 16
      wiredTiger: 64
    "False":  # Not Sharded
      mmapv1: 8
      wiredTiger: 32
  50-50:
    "True":  # Sharded
      mmapv1: 64
      wiredTiger: 64
    "False":  # Not Sharded
      mmapv1: 64
      wiredTiger: 64
  95-5:
    "True": 64  # Sharded
    "False": 32  # Not Sharded
  100-0:
    "True":  # Sharded
      mmapv1: 16
      wiredTiger: 32
    "False":  # Not Sharded
      mmapv1: 32
      wiredTiger: 64


pre_task:
  - on_localhost:
      exec: $DSI_PATH/bin/setup-ycsb.sh
  - on_workload_client:
      exec: rm -rf ycsb*
  - on_workload_client:
      upload_files:
        ycsb.tar.gz: ycsb.tar.gz
      upload_repo_files:
        bin/process_fio_results.py: process_fio_results.py
        bin/process_iperf_results.py: process_iperf_results.py
        bin/fio-test.sh: fio-test.sh
        bin/iperf-test.sh: iperf-test.sh
  - on_workload_client:
      exec: |
        rm -rf YCSB
        mkdir YCSB
        tar zxvf ycsb.tar.gz -C YCSB
        export JAVA_HOME="/usr/java/jdk1.7.0_71/jre"
        source /etc/profile.d/maven.sh && cd /home/ec2-user/YCSB/ycsb-mongodb && mvn clean package
      exec_mongo_shell:
        connection_string: "${mongodb_setup.meta.hostname}:${mongodb_setup.meta.port}"
        # Shard the YCSB cluster if sharding is enabled
        script: |
          if ("${mongodb_setup.meta.is_sharded}" == "True") {
            assert.commandWorked(sh.enableSharding("ycsb"));
            assert.commandWorked(
              sh.shardCollection("ycsb.usertable", {_id: "hashed"}));
            db.printShardingStatus();
          } else {
            print ("Non-sharded cluster");
          }
  - on_all_hosts:
      # Install iperf. It isn't available in yum on AWS instances
      exec: |
        sudo killall iperf3
        rm -rf iperf
        git clone https://github.com/esnet/iperf
        cd iperf/
        git checkout d06415822a
        ./configure
        make
        sudo make install

# Restarting mongodb after ycsb_load, gives a 10% and 5% boost to the following ycsb tests.
# Other than that, this works fine, but we want to postpone introducing a discontinuity
# until storage team is less actively focused on performance work.
# between_tests:
#   - restart_mongodb:
#       clean_logs: true
#       clean_db_dir: false

post_task:
  - on_workload_client:
      retrieve_files:
        fio.json: ../fio.json
        iperf.json: ../iperf.json
