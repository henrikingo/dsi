run:
  - id: ycsb_load-${mongodb_setup.mongod_config_file.storage.engine}
    type: ycsb
    "cmd": "cd YCSB/ycsb-mongodb; ${test_control.numactl} ./bin/ycsb load mongodb -s -P workloads/workloadEvergreen -p mongodb.url=mongodb://${mongodb_setup.meta.hosts}/ycsb -threads 32; sleep 1"
    config_filename: workloadEvergreen
    workload_config: |
      recordcount=5000000
      operationcount=20000000
      workload=com.yahoo.ycsb.workloads.CoreWorkload
      readallfields=true
      readproportion=1.0
      updateproportion=0.0
      scanproportion=0
      insertproportion=0.0
      requestdistribution=zipfian
  - id: ycsb_100read-${mongodb_setup.mongod_config_file.storage.engine}
    type: ycsb
    "cmd": "cd YCSB/ycsb-mongodb; ${test_control.numactl} ./bin/ycsb run mongodb -s -P workloads/workloadEvergreen -p mongodb.url=mongodb://${mongodb_setup.meta.hosts}/ycsb -threads 64; sleep 1"
  - id: ycsb_95read5update-${mongodb_setup.mongod_config_file.storage.engine}
    type: ycsb
    "cmd": "cd YCSB/ycsb-mongodb; ${test_control.numactl} ./bin/ycsb run mongodb -s -P workloads/workloadEvergreen_95read5update -p mongodb.url=mongodb://${mongodb_setup.meta.hosts}/ycsb -threads 64; sleep 1"
    config_filename: workloadEvergreen_95read5update
    workload_config: |
      recordcount=5000000
      operationcount=20000000
      workload=com.yahoo.ycsb.workloads.CoreWorkload
      readallfields=true
      readproportion=0.95
      updateproportion=0.05
      scanproportion=0
      insertproportion=0.0
      requestdistribution=zipfian
  - id: ycsb_50read50update-${mongodb_setup.mongod_config_file.storage.engine}
    type: ycsb
    "cmd": "cd YCSB/ycsb-mongodb; ${test_control.numactl} ./bin/ycsb run mongodb -s -P workloads/workloadEvergreen_50read50update -p mongodb.url=mongodb://${mongodb_setup.meta.hosts}/ycsb -threads 64; sleep 1"
    config_filename: workloadEvergreen_50read50update
    workload_config: |
      recordcount=5000000
      operationcount=20000000
      workload=com.yahoo.ycsb.workloads.CoreWorkload
      readallfields=true
      readproportion=0.5
      updateproportion=0.5
      scanproportion=0
      insertproportion=0.0
      requestdistribution=zipfian
  - id: ycsb_50read50update_w_majority-${mongodb_setup.mongod_config_file.storage.engine}
    type: ycsb
    "cmd": "cd YCSB/ycsb-mongodb; ${test_control.numactl} ./bin/ycsb run mongodb -s -P workloads/workloadEvergreen_50read50update -p mongodb.url=mongodb://${mongodb_setup.meta.hosts}/ycsb?w=majority -threads 64 -p maxexecutiontime=600; sleep 1"
  - id: fio-${mongodb_setup.mongod_config_file.storage.engine}
    type: shell
    cmd: '${test_control.numactl} ./fio-test.sh ${mongodb_setup.meta.hostname}'
    config_filename: fio.ini
    workload_config: ${test_control.common_fio_config}
  - id: iperf
    type: shell
    cmd: '${test_control.numactl} ./iperf-test.sh ${mongodb_setup.meta.hostname}'

pre_task:
  - on_localhost:
      exec: $DSI_PATH/bin/setup-ycsb.sh
  - on_workload_client:
      exec: rm -rf ycsb*
  - on_workload_client:
      upload_files:
        ycsb.tar.gz: ycsb.tar.gz
      upload_repo_files:
        bin/process_fio_results.py: process_fio_results.py
        bin/process_iperf_results.py: process_iperf_results.py
        bin/fio-test.sh: fio-test.sh
        bin/iperf-test.sh: iperf-test.sh
  - on_workload_client:
      exec: |
        chmod 755 fio-test.sh
        chmod 755 iperf-test.sh
        tar zxvf ycsb.tar.gz
        export JAVA_HOME="/usr/java/jdk1.7.0_71/jre"
        source /etc/profile.d/maven.sh && cd /home/ec2-user/YCSB/ycsb-mongodb && mvn clean package
  - on_all_hosts:
      # Install iperf. It isn't available in yum on AWS instances
      exec: |
        sudo killall iperf3
        rm -rf iperf
        git clone https://github.com/esnet/iperf
        cd iperf/
        ./configure
        make
        sudo make install
  - on_workload_client:
      upload_files:
        workloadEvergreen: YCSB/ycsb-mongodb/workloads/workloadEvergreen
        workloadEvergreen_95read5update: YCSB/ycsb-mongodb/workloads/workloadEvergreen_95read5update
        workloadEvergreen_50read50update: YCSB/ycsb-mongodb/workloads/workloadEvergreen_50read50update
        fio.ini: fio.ini
post_task:
  - on_workload_client:
      retrieve_files:
        fio.json: ../fio.json
        iperf.json: ../iperf.json
